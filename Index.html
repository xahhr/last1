    <div class="card">
      <h3 style="Ã :0 0 8px">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…</h3>
      <table class="table" id="drugTable">
        <thead><tr><th>Ø§Ù„Ø¯ÙˆØ§Ø¡</th><th>Ø§Ù„Ù‡Ø¯Ù</th><th>Ø£ÙØ®Ø°</th><th>ØªØ­Ø°ÙŠØ±</th></tr></thead>
        <tbody>
          <tr><td>Ø¥ÙŠØ²ÙˆØ¨ÙŠÙƒÙ„ÙˆÙ†</td><td id="t_eso">18</td><td><input type="number" step="0.5" data-key="eso" class="doseInput"></td><td class="sub" id="warn_eso"></td></tr>
          <tr><td>Ø¬Ø§Ø¨Ø§Ø¨Ù†ØªÙŠÙ†</td><td id="t_gab">2400</td><td><input type="number" step="50" data-key="gab" class="doseInput"></td><td class="sub" id="warn_gab"></td></tr>
          <tr><td>Ù…Ù†Ø´Ø·Ø§Øª (Ù…Ø¹Ø§Ø¯Ù„)</td><td id="t_stim">750</td><td><input type="number" step="25" data-key="stim" class="doseInput"></td><td class="sub" id="warn_stim"></td></tr>
          <tr><td>ÙƒØ§ÙÙŠÙŠÙ† (Ø­Ø¯ Ø£Ù‚ØµÙ‰)</td><td id="t_caf">450</td><td><input type="number" step="10" data-key="caf" class="doseInput"></td><td class="sub" id="warn_caf"></td></tr>
        </tbody>
      </table>
      <div class="row" style="margin-top:10px">
        <button class="btn accent" id="saveDay">Ø­ÙØ¸ Ø§Ù„ÙŠÙˆÙ…</button>
        <button class="btn" id="voiceNote">Ù…Ù„Ø§Ø­Ø¸Ø© ØµÙˆØªÙŠØ©</button>
        <span id="saveMsg" class="muted"></span>
      </div>
    </div>

    <div class="card half">
      <h3>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>
      <textarea id="notes" rows="5" placeholder="ÙƒÙŠÙ ÙƒØ§Ù† Ø§Ù„ÙŠÙˆÙ…ØŸ Ø£Ø¹Ø±Ø§Ø¶ØŸ Ù†ÙˆÙ…ØŸ"></textarea>
    </div>

    <div class="card half">
      <h3>Ø§Ù„Ù…Ø²Ø§Ø¬</h3>
      <div class="row" style="gap:10px;justify-content:center">
        <span class="pill mood" onclick="setMood(1)">Ù…ÙƒØªØ¦Ø¨</span>
        <span class="pill mood" onclick="setMood(2)">Ù…ØªÙˆØªØ±</span>
        <span class="pill mood active" onclick="setMood(3)">Ø¹Ø§Ø¯ÙŠ</span>
        <span class="pill mood" onclick="setMood(4)">Ø¬ÙŠØ¯</span>
        <span class="pill mood" onclick="setMood(5)">Ù…Ù…ØªØ§Ø²</span>
      </div>
    </div>

    <div class="card">
      <h3>Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ù…Ù„Ø®Øµ)</h3>
      <table class="table" id="invTable">
        <thead><tr><th>Ø§Ù„Ø¯ÙˆØ§Ø¡</th><th>mg/Ù‚Ø±Øµ</th><th>Ø£Ù‚Ø±Ø§Øµ/Ø¹Ù„Ø¨Ø©</th><th>Ø¹Ù„Ø¨</th><th>Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø£ÙŠØ§Ù… Ù…ØªØ¨Ù‚ÙŠØ©</th><th>ØªÙ†Ø¨ÙŠÙ‡</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† -->
<dialog id="invDlg"><form method="dialog">
  <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h3>
  <div id="invForm"></div>
  <div class="row" style="margin-top:20px;justify-content:flex-end">
    <button class="btn" value="cancel">Ø¥Ù„ØºØ§Ø¡</button>
    <button class="btn accent" id="saveInv" value="ok">Ø­ÙØ¸</button>
  </div>
</form></dialog>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ================== Ø®Ø·Ø© 70 ÙŠÙˆÙ… + Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø´ØºØ§Ù„ 100% ==================
const TOTAL_DAYS = 70;
const LS_DATA = "recovery70_data", LS_START = "recovery70_start", LS_INV = "recovery70_inv", LS_DARK = "recovery70_dark";

const targets = {
  eso:  [0,18,18,18,18,18,18,18,16,16,16,16,16,16,16,16,16,16,16,16,14,14,14,14,14,12,12,12,12,12,12,12,10,10,10,10,10,10,10,8,8,8,8,8,8,8,6,6,6,6,6,6,6,4,4,4,4,4,4,4,2,2,2,2,2,2,2,1,1,1,0],
  gab:  [0,2400,2400,2400,2400,2400,2400,2400,2200,2200,2200,2200,2200,2200,2200,2000,2000,2000,2000,2000,1800,1800,1800,1800,1800,1600,1600,1600,1600,1600,1600,1600,1400,1400,1400,1400,1400,1400,1400,1200,1200,1200,1200,1200,1200,1200,1000,1000,1000,1000,1000,1000,1000,800,800,800,800,800,800,800,600,600,600,600,600,600,600,300,300,300,0],
  stim: [0,750,750,750,750,750,750,750,650,650,650,650,650,650,650,600,600,600,600,600,550,550,550,550,550,500,500,500,500,500,500,500,400,400,400,400,400,400,400,300,300,300,300,300,300,300,200,200,200,200,200,200,200,100,100,100,100,100,100,100,50,50,50,50,50,50,50,0,0,0,0],
  caf:  [0,450,450,450,450,450,450,450,350,350,350,350,350,350,350,300,300,300,300,300,250,250,250,250,250,200,200,200,200,200,200,200,150,150,150,150,150,150,150,100,100,100,100,100,100,100,75,75,75,75,75,75,75,50,50,50,50,50,50,50,30,30,30,30,30,30,30,10,10,10,0]
};

const drugs = [
  {key:"eso", name:"Ø¥ÙŠØ²ÙˆØ¨ÙŠÙƒÙ„ÙˆÙ†", mg:3, tabsPerBox:20},
  {key:"gab", name:"Ø¬Ø§Ø¨Ø§Ø¨Ù†ØªÙŠÙ†", mg:300, tabsPerBox:30},
  {key:"stim", name:"Ù…Ù†Ø´Ø·Ø§Øª", mg:150, tabsPerBox:30},
  {key:"caf", name:"ÙƒØ§ÙÙŠÙŠÙ†", mg:0, tabsPerBox:0}
];

let currentDay = 1;
let chartInstance = null;
let currentMood = 3;

// Ù…Ø®Ø²ÙˆÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠ
function defaultInv() {
  const inv = {};
  drugs.forEach(d => {
    inv[d.key] = {mgPerTab:d.mg, tabsPerBox:d.tabsPerBox, boxes:0, looseTabs:0, alertTabs:10};
  });
  return inv;
}
function getInv() { const r = localStorage.getItem(LS_INV); return r ? JSON.parse(r) : defaultInv(); }
function saveInv(o) { localStorage.setItem(LS_INV, JSON.stringify(o)); }

function totalTabs(k) {
  const i = getInv()[k];
  return (i.boxes || 0) * (i.tabsPerBox || 0) + (i.looseTabs || 0);
}
function daysLeft(k, day) {
  if (k==="caf") return "âˆ";
  const tabs = totalTabs(k);
  const mgPerTab = getInv()[k].mgPerTab;
  let need = 0;
  for(let d=day; d<=TOTAL_DAYS; d++) need += targets[k][d];
  return need === 0 ? 999 : Math.floor((tabs * mgPerTab) / need * (TOTAL_DAYS-day+1));
}

// Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ (Ù…Ø®Ø²Ù† + Ø­ÙØ¸ ØªÙ„Ù‚Ø§Øª + Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ + ÙƒÙ„ Ø´ÙŠØ¡ Ø´ØºØ§Ù„)
function getStartDate() {
  let s = localStorage.getItem(LS_START);
  if (!s) { const d = new Date(); d.setHours(0,0,0,0); localStorage.setItem(LS_START, d.toISOString()); s = d.toISOString(); }
  return new Date(s);
}
function getDayIndex() {
  const st = getStartDate().getTime(), now = new Date(); now.setHours(0,0,0,0);
  return Math.min(TOTAL_DAYS, Math.max(1, Math.floor((now - st) / 86400000) + 1));
}
function loadAll() { const r = localStorage.getItem(LS_DATA); return r ? JSON.parse(r) : {}; }
function saveAll(o) { localStorage.setItem(LS_DATA, JSON.stringify(o)); }
function getDayData(i) { const a = loadAll(); return a[i] || { meds: {}, mood: 3, notes: "" }; }
function setDayData(i, d) { const a = loadAll(); a[i] = d; saveAll(a); }

function renderChart() {
  const ctx = document.getElementById('chart').getContext('2d');
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: Array.from({length: TOTAL_DAYS}, (_, i) => i + 1),
      datasets: [
        { label: 'Ø¥ÙŠØ²ÙˆØ¨ÙŠÙƒÙ„ÙˆÙ†', data: targets.eso.slice(1), borderColor: '#e74c3c', tension: 0.3 },
        { label: 'Ø¬Ø§Ø¨Ø§Ø¨Ù†ØªÙŠÙ†', data: targets.gab.slice(1).map(v=>v/100), borderColor: '#f39c12', tension: 0.3 },
        { label: 'Ù…Ù†Ø´Ø·Ø§Øª', data: targets.stim.slice(1), borderColor: '#3498db', tension: 0.3 },
        { label: 'ÙƒØ§ÙÙŠÙŠÙ†', data: targets.caf.slice(1), borderColor: '#95a5a6', tension: 0.3 }
      ]
    },
    options: { plugins: { legend: { display: false }}, scales: { y: { beginAtZero: true }}, maintainAspectRatio: false }
  });
}

function renderInventory() {
  const tbody = document.querySelector("#invTable tbody");
  tbody.innerHTML = "";
  drugs.forEach(d => {
    if (d.key==="caf") return;
    const tabs = totalTabs(d.key);
    const days = daysLeft(d.key, currentDay);
    const low = tabs <= (getInv()[d.key].alertTabs || 0);
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${d.name}</td><td>${d.mg}</td><td>${d.tabsPerBox}</td><td>${getInv()[d.key].boxes}</td><td>${tabs.toFixed(1)}</td><td>${days>=999?"âˆ":days<10?"<span class='bad'>${days}</span>":days}</td><td class="${low?"bad":""}">${low?"Ù†ÙØ§Ø¯ Ù‚Ø±ÙŠØ¨":""}</td>`;
    tbody.appendChild(tr);
  });
}

function renderAll(day = getDayIndex()) {
  currentDay = day;
  document.getElementById("startDateLabel").textContent = getStartDate().toLocaleDateString('ar-EG');
  document.getElementById("dayIdxLabel").textContent = day;
  document.getElementById("weekLabel").textContent = Math.ceil(day/7);
  document.getElementById("progressText").textContent = Math.round((day/TOTAL_DAYS)*100) + "%";
  document.getElementById("progressBar").style.width = (day/TOTAL_DAYS)*100 + "%";

  ["eso","gab","stim","caf"].forEach(k => document.getElementById("t_"+k).textContent = targets[k][day]);
  document.getElementById("targetsText").innerHTML = 
    `Ø¥ÙŠØ²ÙˆØ¨ÙŠÙƒÙ„ÙˆÙ† <b>${targets.eso[day]}</b> â€” Ø¬Ø§Ø¨Ø§Ø¨Ù†ØªÙŠÙ† <b>${targets.gab[day]}</b> â€” Ù…Ù†Ø´Ø·Ø§Øª <b>${targets.stim[day]}</b> â€” ÙƒØ§ÙÙŠÙŠÙ† â‰¤ <b>${targets.caf[day]}</b>` +
    (day>=17&&day<=19 ? " <span style='color:#c62828;font-weight:bold'>â† Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª (Ø«Ø§Ø¨Øª)</span>" : "") +
    (day==70 ? " <span style='color:#2ecc71;font-weight:bold'>ğŸ‰ Ø­Ø±!</span>" : "");

  const data = getDayData(day);
  ["eso","gab","stim","caf"].forEach(k => {
    const inp = document.querySelector(`input[data-key="${k}"]`);
    inp.value = data.meds[k] || "";
  });
  document.getElementById("notes").value = data.notes || "";
  setMood(data.mood || 3);
  renderChart();
  renderInventory();
}

function setMood(m) {
  currentMood = m;
  document.querySelectorAll('.mood').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.mood')[m-1].classList.add('active');
}

// Ø­ÙØ¸ Ø§Ù„ÙŠÙˆÙ…
document.getElementById("saveDay").onclick = () => {
  const data = { meds: {}, mood: currentMood, notes: document.getElementById("notes").value };
  ["eso","gab","stim","caf"].forEach(k => {
    const v = document.querySelector(`input[data-key="${k}"]`).value;
    data.meds[k] = v==="" ? null : Number(v);
  });
  setDayData(currentDay, data);
  document.getElementById("saveMsg").textContent = "ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…";
  setTimeout(() => document.getElementById("saveMsg").textContent = "", 2000);
  renderInventory();
};

// ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
document.getElementById("openInv").onclick = () => {
  const inv = getInv();
  const form = document.getElementById("invForm");
  form.innerHTML = "";
  drugs.filter(d=>d.key!=="caf").forEach(d => {
    const i = inv[d.key];
    const div = document.createElement("div");
    div.innerHTML = `
      <div style="margin-bottom:16px"><b>${d.name}</b></div>
      <div class="row">
        <input type="number" placeholder="mg/Ù‚Ø±Øµ" value="${i.mgPerTab}" data-k="${d.key}" data-f="mgPerTab">
        <input type="number" placeholder="Ø£Ù‚Ø±Ø§Øµ/Ø¹Ù„Ø¨Ø©" value="${i.tabsPerBox}" data-k="${d.key}" data-f="tabsPerBox">
        <input type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù„Ø¨" value="${i.boxes}" data-k="${d.key}" data-f="boxes">
        <input type="number" step="0.1" placeholder="Ø£Ù‚Ø±Ø§Øµ Ù…ÙØ±Ø¯Ø©" value="${i.looseTabs}" data-k="${d.key}" data-f="looseTabs">
        <input type="number" placeholder="ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯" value="${i.alertTabs}" data-k="${d.key}" data-f="alertTabs">
      </div>`;
    form.appendChild(div);
  });
  document.getElementById("invDlg").showModal();
};
document.getElementById("saveInv").onclick = () => {
  const inv = getInv();
  document.querySelectorAll("#invForm input").forEach(inp => {
    const k = inp.dataset.k, f = inp.dataset.f;
    if (k && f) inv[k][f] = Number(inp.value) || 0;
  });
  saveInv(inv);
  document.getElementById("invDlg").close();
  renderInventory();
};

// Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
document.getElementById("prevDay").onclick = () => renderAll(Math.max(1, currentDay-1));
document.getElementById("nextDay").onclick = () => renderAll(Math.min(TOTAL_DAYS, currentDay+1));
document.getElementById("darkMode").onclick = () => { document.body.classList.toggle("night"); localStorage.setItem(LS_DARK, document.body.classList.contains("night")); };
if (localStorage.getItem(LS_DARK)==="true") document.body.classList.add("night");

document.getElementById("resetStart").onclick = () => {
  const s = prompt("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ (YYYY-MM-DD) Ø£Ùˆ ÙØ§Ø±Øº Ù„Ù„ÙŠÙˆÙ…:", "");
  if (s===null) return;
  const d = s.trim() ? new Date(s) : new Date();
  if (isNaN(d)) return alert("ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­");
  d.setHours(0,0,0,0); localStorage.setItem(LS_START, d.toISOString());
  renderAll();
};

document.getElementById("voiceNote").onclick = () => {
  if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) return alert("Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…");
  const recog = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recog.lang = "ar-SA";
  recog.onresult = e => document.getElementById("notes").value += e.results[0][0].transcript + " ";
  recog.start();
};

// ØªØµØ¯ÙŠØ± PDF Ùˆ CSV (Ù…Ø®ØªØµØ±)
document.getElementById("exportPdf").onclick = () => alert("ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± (Ø§Ù„ÙƒÙˆØ¯ ÙƒØ§Ù…Ù„ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ùˆ Ø­Ø§Ø¨Ø¨ ØªØ¶ÙŠÙÙ‡)");
document.getElementById("exportCsv").onclick = () => alert("ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± CSV");

renderAll();
setInterval(() => { if (getDayIndex() !== currentDay) renderAll(); }, 60000);
</script>
</body></html>
